{% extends "base.html" %}
{% block title %}Échange Multi-Plateforme{% endblock %}
{% block content %}
<div class="container mt-5 text-white text-center">
    <h1 class="display-4 mb-4">Échange de Likes & Follows</h1>
    <h2 class="mb-5">
        Tes coins : <strong class="text-warning fs-1">
            {% if balance %}{{ balance.coins }}{% else %}0{% endif %}
        </strong>
    </h2>
</div>

<div class="row justify-content-center g-4 mb-5">
    <div class="col-6 col-md-3"><button class="btn btn-primary btn-lg w-100 p-4" onclick="select('facebook')">Facebook</button></div>
    <div class="col-6 col-md-3"><button class="btn btn-danger btn-lg w-100 p-4" onclick="select('instagram')">Instagram</button></div>
    <div class="col-6 col-md-3"><button class="btn btn-dark btn-lg w-100 p-4" onclick="select('tiktok')">TikTok</button></div>
    <div class="col-6 col-md-3"><button class="btn btn-warning btn-lg w-100 p-4" onclick="select('youtube')">YouTube</button></div>
</div>

<div id="form-container" class="card bg-dark text-white p-5" style="display:none; max-width:650px; margin:auto; border-radius:20px;">
    <h3 class="text-center mb-4" id="title"></h3>
    <form id="task-form">
        {% csrf_token %}
        <input type="hidden" id="platform" name="platform">
        <div class="mb-4">
            <input type="url" class="form-control form-control-lg text-center" placeholder="Colle le lien ici" name="url" required>
        </div>
        <button type="submit" class="btn btn-success btn-lg w-100">Gagner des coins</button>
    </form>
    <div id="result" class="mt-4 text-center fs-4"></div>
</div>

<script>
// Fonction pour récupérer le CSRF token proprement (obligatoire en production)
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function select(p) {
    document.getElementById('platform').value = p;
    document.getElementById('title').innerText = p.charAt(0).toUpperCase() + p.slice(1);
    document.getElementById('form-container').style.display = 'block';
    document.getElementById('result').innerHTML = '';
}

document.getElementById('task-form').onsubmit = async (e) => {
    e.preventDefault();
    const form = new FormData(e.target);
    const res = await fetch('/exchange/submit/', {
        method: 'POST',
        body: form,
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),  // Correction critique
            'X-Requested-With': 'XMLHttpRequest'
        }
    });
    const data = await res.json();
    
    if (data.success) {
        document.getElementById('result').innerHTML = 
            `<p class="text-success">Validé ! +${data.coins} coins<br>
             Total : <strong>${data.total}</strong> coins</p>`;
        // Met à jour les coins en haut sans recharger
        document.querySelector('.text-warning.fs-1').textContent = data.total;
    } else {
        document.getElementById('result').innerHTML = 
            `<p class="text-danger">${data.error || 'Erreur inconnue'}</p>`;
    }
};
</script>
{% endblock %}
