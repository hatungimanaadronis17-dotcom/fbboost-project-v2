{% extends "base.html" %}
{% block title %}Échange Multi-Plateforme{% endblock %}
{% block content %}
<div class="container mt-5 text-white text-center">
    <h1 class="display-4 mb-4">Échange de Likes & Follows</h1>
    <h2 class="mb-5">
        Tes coins : <strong class="text-warning fs-1">
            {% if balance %}{{ balance.coins }}{% else %}0{% endif %}
        </strong>
    </h2>
</div>

<div class="row justify-content-center g-4 mb-5">
    <div class="col-6 col-md-3"><button class="btn btn-primary btn-lg w-100 p-4" onclick="select('facebook')">Facebook</button></div>
    <div class="col-6 col-md-3"><button class="btn btn-danger btn-lg w-100 p-4" onclick="select('instagram')">Instagram</button></div>
    <div class="col-6 col-md-3"><button class="btn btn-dark btn-lg w-100 p-4" onclick="select('tiktok')">TikTok</button></div>
    <div class="col-6 col-md-3"><button class="btn btn-warning btn-lg w-100 p-4" onclick="select('youtube')">YouTube</button></div>
</div>

<div id="form-container" class="card bg-dark text-white p-5" style="display:none; max-width:650px; margin:auto; border-radius:20px;">
    <h3 class="text-center mb-4" id="title"></h3>
    <form id="task-form">
        {% csrf_token %}
        <input type="hidden" id="platform" name="platform">
        <div class="mb-4">
            <input type="url" class="form-control form-control-lg text-center" placeholder="Colle le lien ici" name="url" required>
        </div>
        <button type="submit" class="btn btn-success btn-lg w-100">Gagner des coins</button>
    </form>
    <div id="result" class="mt-4 text-center fs-4"></div>
</div>

<script>
// Récupère le token CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function select(p) {
    document.getElementById('platform').value = p;
    document.getElementById('title').innerText = p.charAt(0).toUpperCase() + p.slice(1);
    document.getElementById('form-container').style.display = 'block';
    document.getElementById('result').innerHTML = '';
}

document.getElementById('task-form').onsubmit = async (e) => {
    e.preventDefault();
    document.getElementById('result').innerHTML = '<p class="text-info">Vérification en cours...</p>';

    const form = new FormData(e.target);
    
    try {
        const res = await fetch('/exchange/submit/', {
            method: 'POST',
            body: form,
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        const data = await res.json();

        if (data.success) {
            document.getElementById('result').innerHTML = 
                `<p class="text-success">${data.message}<br>
                 Total : <strong>${data.total}</strong> coins</p>`;
            // Mise à jour du solde en haut sans recharger la page
            document.querySelector('.text-warning.fs-1').textContent = data.total;
        } else {
            let errorMsg = data.error || data.message || 'Erreur inconnue';
            if (data.cooldown) errorMsg = data.error;
            document.getElementById('result').innerHTML = 
                `<p class="text-danger">${errorMsg}</p>`;
        }
    } catch (err) {
        document.getElementById('result').innerHTML = 
            '<p class="text-danger">Erreur de connexion. Réessayez plus tard.</p>';
        console.error(err);
    }
};
</script>
{% endblock %}
